<?xml version="1.0" encoding="utf-8"?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:widget="http://www.netvibes.com/ns/">

<head>
    <meta name="author" content="Dassault Systèmes" />
    <meta name="autoRefresh" content="-1" />

    <script type="text/javascript" src="../AmdLoader/AmdLoader.js"></script>
    <link rel="stylesheet" type="text/css" href="../c/UWA/assets/css/standalone.css" />
    <script type="text/javascript" src="../c/UWA/js/UWA_Standalone_Alone.js"></script>
    <script type="text/javascript" src="../WebappsUtils/WebappsUtils.js"></script>
    <script type="text/javascript" src="../UIKIT/UIKIT.js"></script>
    <link rel="stylesheet" href="../UIKIT/UIKIT.css" />

    <!-- <script type="text/javascript" src="index.js"></script> -->

    <widget:preferences>
        <!-- <widget:preference type="hidden" name="SERVER" defaultValue="dspart001-eu1-partners" />-->
        <!-- <widget:preference type="hidden" name="CHANNEL" defaultValue="dsrussiatechclub" /> -->
        <widget:preference type="hidden" name="CHANNEL" defaultValue="-1001255384579" />
        <widget:preference type="hidden" name="COMMUNITY_ID" defaultValue="3jnbbhBeT7q3ioBmKeXV7Q" />
        <!-- <widget:preference type="hidden" name="COMMUNITY_ID" defaultValue="DS RUSSIA TECH CLUB" /> -->
    </widget:preferences>

    <script type="text/javascript">
    
    "use strict";

    function _toConsumableArray(arr) {
      return (
        _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread()
      );
    }

    function _nonIterableSpread() {
      throw new TypeError("Invalid attempt to spread non-iterable instance");
    }

    function _iterableToArray(iter) {
      if (
        Symbol.iterator in Object(iter) ||
        Object.prototype.toString.call(iter) === "[object Arguments]"
      )
        return Array.from(iter);
    }

    function _arrayWithoutHoles(arr) {
      if (Array.isArray(arr)) {
        for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) {
          arr2[i] = arr[i];
        }
        return arr2;
      }
    }

    function _instanceof(left, right) {
      if (
        right != null &&
        typeof Symbol !== "undefined" &&
        right[Symbol.hasInstance]
      ) {
        return !!right[Symbol.hasInstance](left);
      } else {
        return left instanceof right;
      }
    }

    var dependency = [
      "DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices",
      "DS/UIKIT/Input/Button",
      "DS/UIKIT/Input/Text",
      "DS/UIKIT/Input/Select",
      "DS/UIKIT/Input/File",
      "DS/UIKIT/Scroller",
      "DS/UIKIT/Alert",
      "DS/UIKIT/Carousel",
      "DS/WAFData/WAFData",
      "DS/UIKIT/Mask"
    ];

    function executeWidgetCode(widget) {
      console.log(widget);

      require(dependency, function(
        i3DXCompassPlatformServices,
        Button,
        Text,
        Select,
        File,
        Scroller,
        Alert,
        Carousel,
        WAFData,
        Mask
      ) {
        function createSwymPost(infos, content) {
          function getToken(cb) {
            var tokenPath = widget.swymURL + "/api/index/tk";
            var addPostRequest = {
              method: "GET",
              async: true,
              onComplete: function onComplete(response, headers, xhr) {
                var result = JSON.parse(response).result;
                cb(result.ServerToken);
              },
              onFailure: function onFailure(e) {
                console.log("Error: " + e);
                widget.notificationElement.add({
                  className: "error",
                  message: "Ошибка при создании вопроса в 3DSwym"
                });
                Mask.unmask(widget.body);
              }
            };
            WAFData.authenticatedRequest(tokenPath, addPostRequest);
          }

          function addMedias(token, cb) {
            var communityId = widget.getValue("COMMUNITY_ID");
            var mediaAddUrl = widget.swymURL + "/api/media/add";
            var mediaFiles = infos.find(function(f) {
              return f.key === "media";
            }).value.elements.input.files;
            var links = [];

            function addMedia(file) {
              var formData = new FormData();
              formData.append("community_id", communityId);
              formData.append("published", "0");
              formData.append("is_illustration", "1");
              formData.append("filename", file.name);
              formData.append("userFile", file);
              var addMediaRequest = {
                method: "POST",
                async: true,
                data: formData,
                headers: {
                  "X-DS-SWYM-CSRFTOKEN": token
                },
                onComplete: function onComplete(response, headers, xhr) {
                  widget.notificationElement.add({
                    className: "success",
                    message: "Медиа успешно загружены в 3DSwym"
                  });
                  var responseJson = JSON.parse(response);
                  links.push(
                    '<img data-source="swym" data-community-id="'
                      .concat(communityId, '" data-media-id="')
                      .concat(responseJson.result.id_media, '" data-media-type="')
                      .concat(
                        responseJson.result.media_type,
                        '" data-position="center" >'
                      )
                  );
                  if (links.length === mediaFiles.length) cb(links);
                },
                onFailure: function onFailure(e) {
                  console.log("Error: " + e);
                  widget.notificationElement.add({
                    className: "error",
                    message: "Ошибка при загрузке медиа в 3DSwym"
                  });
                  Mask.unmask(widget.body);
                }
              };
              WAFData.authenticatedRequest(mediaAddUrl, addMediaRequest);
            }

            Array.from(mediaFiles).forEach(function(f) {
              return addMedia(f);
            });
          }

          function createPost(token, title, question, cb) {
            var createPostUrl = widget.swymURL + "/api/question/add";
            var body = {
              params: {
                community_id: widget.getValue("COMMUNITY_ID"),
                published: 1,
                contentType: "iquestion",
                question: question,
                title: title,
                withThumbnailsInfo: true
              }
            };
            var addPostRequest = {
              method: "POST",
              async: true,
              data: JSON.stringify(body),
              headers: {
                "Content-Type": "application/json; charset=UTF-8",
                "X-DS-SWYM-CSRFTOKEN": token
              },
              onComplete: function onComplete(response, headers, xhr) {
                widget.notificationElement.add({
                  className: "success",
                  message: "Вопрос успешно создан"
                });
                var result = JSON.parse(response).result;
                var postLink =
                  widget.swymURL +
                  "/%23community:" +
                  result._community.id +
                  "/iquestion:" +
                  result.id;
                var user = result.author.first_name + " " + result.author.last_name;
                cb(user, postLink);
                widget.postLinkHTML =
                  widget.swymURL +
                  "/#community:" +
                  result._community.id +
                  "/iquestion:" +
                  result.id;
                Mask.unmask(widget.body);
                if (widget.postLinkHTML) widget.openLinkButton.show();
              },
              onFailure: function onFailure(e) {
                console.log("Error: " + e);
                widget.notificationElement.add({
                  className: "error",
                  message: "Ошибка при создании вопроса в 3DSwym"
                });
                Mask.unmask(widget.body);
              }
            };
            WAFData.authenticatedRequest(createPostUrl, addPostRequest);
          }

          var title = infos.find(function(f) {
            return f.key === "title";
          }).value;
          var question = content.outerHTML;
          getToken(function(token) {
            addMedias(token, function(links) {
              links.forEach(function(f) {
                question += f;
              });
              createPost(token, title, question, function(fromUser, postUrl) {
                var message = "\u0412\u043E\u043F\u0440\u043E\u0441: <b>"
                  .concat(encodeURI(title), "</b>%0A\u041E\u0442: <strong>")
                  .concat(encodeURI(fromUser), '</strong>%0A<a href="')
                  .concat(
                    postUrl,
                    '">\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u043F\u043E\u0441\u0442</a>'
                  );
                sendTelegramMessage(message);
              });
            });
          });
        }

        function sendTelegramMessage(text) {
          var botApi = "https://api.telegram.org";
          var telegaBotPath = ""
            .concat(
              botApi,
              "/bot902867180:AAGmQpj7CVmycg8-4XOk2IqexHaXdF3fl0o/sendMessage?chat_id="
            )
            .concat(widget.getValue("CHANNEL"), "&parse_mode=HTML&text=")
            .concat(text);
          var xhr = new XMLHttpRequest();
          xhr.open("GET", telegaBotPath);
          xhr.send();

          xhr.onload = function() {
            if (xhr.status != 200) {
              widget.notificationElement.add({
                className: "error",
                message: "Ошибка уведомления в Telegram"
              });
              Mask.unmask(widget.body);
            } else {
              widget.notificationElement.add({
                className: "success",
                message: "Уведомление в Telegram выполнено успешно"
              });
            }
          };
        }

        function onInputChange(e) {
          setTimeout(function() {
            var value = e.target.value;
            e.target.setStyles({
              border: value.length > 0 ? null : "2px dashed #ea4f37"
            });
          }, 10);
        }

        function getInput(field) {
          switch (field.type) {
            case "text":
              var hasMultiline = field.multiline ? true : false;
              var textElement = new Text({
                placeholder: "Введите значение...",
                multiline: hasMultiline,
                rows: 5,
                events: {
                  onKeyDown: onInputChange,
                  onChange: onInputChange
                }
              });
              textElement.getContent().setStyles({
                maxWidth: "100%",
                minWidth: "100%"
              });
              return textElement;

            case "select":
              var selectElement = new Select({
                isRequired: field.isRequired,
                custom: false,
                placeholder: "Выберите значение...",
                options: field.options,
                events: {
                  onChange: onInputChange
                }
              });
              return selectElement;

            case "file":
              return new File({
                multiple: true,
                buttonBefore: false,
                name: "file-input",
                buttonClassName: "primary",
                placeholder: "Файлы...",
                buttonText: "Выберите файлы"
              });
          }
        }

        function getField(field) {
          var titleElements = [field.title];
          if (field.isRequired)
            titleElements.push('<span style="color: #db4437;"> *</span>');
          var input = getInput(field);
          var element = UWA.createElement("div", {
            "class": "card",
            html: [
              {
                tag: "div",
                "class": "card-block",
                html: {
                  tag: "h4",
                  styles: {
                    paddingLeft: "5px"
                  },
                  html: titleElements
                }
              },
              {
                tag: "div",
                "class": "card-footer",
                html: input
              }
            ]
          });
          return {
            element: element,
            field: field,
            input: input
          };
        }

        function checkFields(fields) {
          var isOk = true;
          fields.forEach(function(f) {
            if (f.field.isRequired) {
              var value = f.input.getValue();
              value = _instanceof(value, Array) ? value[0] : value;
              f.input.elements.input.setStyles({
                border: value.length > 0 ? null : "2px dashed #ea4f37"
              });
              if (value.length === 0 && isOk) isOk = false;
            }
          });
          return isOk;
        }

        function onLoad() {
          var title =
            "Форма обращения за поддержкой в департамент DS Russia TechSales";
          widget.setTitle(title);
          var fields = form.map(function(f) {
            return getField(f);
          });
          var secondFields = undefined;

          function onBackClick() {
            var isLastSlide = carousel.current.id === "slide-3";
            widget.openLinkButton.hide();

            if (isLastSlide) {
              carousel.slide(0);
              setTimeout(function() {
                previousButton.hide();
                nextButton.setValue("Продолжить");
                nextButton.show();
                requiredMsgElement.show();
              }, 800);
            } else {
              nextButton.setValue("Продолжить");
              nextButton.setClassName("primary");
              previousButton.hide();
              nextButton.enable();
              carousel.slide("left");
            }
          }

          function onNextClick() {
            var isFirstSlide = carousel.current.id === "slide-1";
            var isOk = checkFields(isFirstSlide ? fields : secondFields);
            var requestTypeField = fields.find(function(f) {
              return f.field.key == "request_type";
            });
            var requestClassificatorField = fields.find(function(f) {
              return f.field.key == "request_classificator";
            });

            if (isFirstSlide && isOk) {
              var typeValue = requestTypeField.input.getValue()[0];
              var secondFieldsInfo =
                requestTypeField.field.options[typeValue].fields;
              secondFields = secondFieldsInfo.map(function(f) {
                return getField(f);
              });
              secondSlideElement.setHTML(
                secondFields.map(function(f) {
                  return f.element;
                })
              );
              carousel.slide();
              nextButton.setValue("Отправить вопрос");
              previousButton.show();
            } else if (isOk) {
              var addInfoElement = function addInfoElement(title, value, key) {
                value = _instanceof(value, Array) ? value[0] : value;
                if (value === "" || key === "media") return;
                infos.push({
                  value: value,
                  title: title,
                  key: key
                });
                infoElements.push(
                  UWA.createElement("p", {
                    styles: {
                      margin: "5px 0"
                    },
                    html: [
                      {
                        tag: "strong",
                        styles: {
                          fontWeight: "bold"
                        },
                        text: title + ": "
                      },
                      {
                        tag: "span",
                        text: value
                      }
                    ]
                  })
                );
              };

              Mask.mask(widget.body, "Пожалуйста, подождите...");
              var infoElements = [];
              var infos = [];
              var _typeValue =
                requestTypeField.field.options[requestTypeField.input.getValue()]
                  .label;
              addInfoElement(
                requestTypeField.field.title,
                _typeValue,
                requestTypeField.field.key
              );
              addInfoElement(
                requestClassificatorField.field.title,
                requestClassificatorField.input.getValue(),
                requestClassificatorField.field.key
              );
              secondFields.forEach(function(f) {
                var value = f.input.getValue();
                addInfoElement(f.field.title, value, f.field.key);
              });
              var content = UWA.createElement("div", {
                html: infoElements
              });
              lastSlideElement.setHTML(content);
              requiredMsgElement.hide();
              carousel.slide();
              nextButton.hide();
              previousButton.setValue("В начало");
              var media = secondFields.find(function(f) {
                return f.field.key === "media";
              });
              infos.push({
                value: media.input,
                title: media.field.title,
                key: "media"
              });
              createSwymPost(infos, content);
            } else {
              widget.notificationElement.add({
                className: "error",
                message: "Заполните обязательные поля"
              });
            }
          }

          var previousButton = new Button({
            value: "Назад",
            className: "default"
          }).hide();
          previousButton.addEvent("onClick", onBackClick);
          var nextButton = new Button({
            value: "Продолжить",
            className: "primary"
          });
          nextButton.getContent().style.marginLeft = "10px";
          nextButton.addEvent("onClick", onNextClick);
          var openLinkButton = new Button({
            value: "Ссылка на пост",
            className: "success active"
          });
          openLinkButton.getContent().style.marginLeft = "10px";
          openLinkButton.addEvent("onClick", function() {
            if (widget.postLinkHTML) window.open(widget.postLinkHTML, "_blank");
            widget.postLinkHTML = undefined;
          });
          widget.openLinkButton = openLinkButton;
          openLinkButton.hide();
          var carousel = new Carousel({
            arrows: false,
            autoPlay: false,
            animation: "slide",
            dots: false,
            infinite: false
          });
          carousel.getContent().setStyles({
            marginRight: "15px"
          });
          var firstSlideElement = UWA.createElement("div", {
            id: "slide-1",
            html: _toConsumableArray(
              fields.map(function(f) {
                return f.element;
              })
            )
          });
          var secondSlideElement = UWA.createElement("div", {
            id: "slide-2"
          });
          var lastSlideElement = UWA.createElement("div", {
            id: "slide-3"
          });
          carousel.add([firstSlideElement, secondSlideElement, lastSlideElement]);
          var requiredMsgElement = UWA.createElement("div", {
            styles: {
              color: "#db4437",
              fontSize: "10px"
            },
            text: "* Обязательно для заполнения"
          });
          var contentScroller = new Scroller({
            element: UWA.createElement("div", {
              styles: {
                height: "calc(100% - 170px)"
              },
              html: [carousel, requiredMsgElement]
            })
          });
          var formElement = UWA.createElement("div", {
            html: {
              tag: "div",
              styles: {
                position: "absolute",
                top: 0,
                bottom: 0,
                left: 0,
                right: 0,
                background: "whitesmoke"
              },
              html: {
                tag: "div",
                styles: {
                  position: "relative",
                  height: "100%",
                  padding: "0px 10px 0 25px"
                },
                html: [
                  {
                    tag: "h3",
                    text: title,
                    styles: {
                      color: "#005686",
                      padding: "8px 0"
                    }
                  },
                  contentScroller,
                  {
                    tag: "div",
                    styles: {
                      margin: "20px 15px",
                      textAlign: "center"
                    },
                    html: [previousButton, nextButton, openLinkButton]
                  }
                ]
              }
            }
          });
          widget.setBody(formElement);
          widget.notificationElement = new Alert({
            visible: true,
            autoHide: true,
            fullWidth: true,
            hideDelay: 2000
          }).inject(widget.body);
          widget.notificationElement.elements.container.setStyles({
            position: "absolute",
            left: "0",
            top: "0",
            right: "0"
          });
        }

        i3DXCompassPlatformServices.getPlatformServices({
          onComplete: function onComplete(e) {
            widget.swymURL = e[0]["3DSwym"];
            widget.addEvents({
              onLoad: onLoad,
              onRefresh: onLoad,
              onResize: function onResize() {}
            });
          },
          onFailure: function onFailure(e) {
            console.error(e);
          }
        });
        widget.setAutoRefresh(-1);
      });
    }

    var commonFields = [
      {
        key: "title",
        isRequired: true,
        title: "Краткая формулировка запроса",
        type: "text"
      },
      {
        isRequired: true,
        title: "Детальное описание запроса, какая помощь необходима",
        multiline: true,
        type: "text"
      },
      {
        key: "media",
        title:
          "Загрузите сопроводительные файлы (pdf, pptx, docx, xlsx, jpg, jpeg, png)",
        type: "file"
      }
    ];
    var secondaryFields = [].concat(commonFields, [
      {
        isRequired: true,
        title: "Выберите тип продукта",
        type: "select",
        options: [
          {
            value:
              "3DEXPERIENCE Platform (любой сервис, продукт или приложение на Платформе)"
          },
          {
            value: "Брендовый продукт"
          },
          {
            value: "Другое (сторонний продукт, обеспечивающий работу продуктов DS)"
          }
        ]
      },
      {
        isRequired: true,
        title: "Версия и релиз",
        type: "text"
      },
      {
        isRequired: true,
        title: "Уровень обновления",
        type: "text"
      },
      {
        isRequired: true,
        title: "Имя приложение (App), технического продукта",
        type: "text"
      },
      {
        title: "Тип приложения",
        type: "select",
        options: [
          {
            value: "Настольное"
          },
          {
            value: "Веб-приложение"
          },
          {
            value: "Сервис 3DEXPERIENCE Platform"
          }
        ]
      },
      {
        title: "Лицензия или Роль",
        type: "text"
      }
    ]);
    var form = [
      {
        key: "request_classificator",
        isRequired: true,
        type: "select",
        title: "Классификатор запроса",
        description:
          "Укажите в каком контексте происходит обращение за технической поддержкой, это позволит определить приоритетность вашего запроса",
        options: [
          {
            value: "Помощь в пресейле (есть Oppty) (Высокий приоритет)"
          },
          {
            value: "Помощь в пресейле (нет Oppty)"
          },
          {
            value:
              "Техническая поддержка заказчика (Service Request зарегистрирован) (Высокий приоритет)"
          },
          {
            value:
              "Техническая поддержка заказчика (Service Request не зарегистрирован)"
          },
          {
            value: "Сервисные работы у заказчика"
          },
          {
            value: "Самообразование и повышение квалификации"
          }
        ]
      },
      {
        key: "request_type",
        isRequired: true,
        type: "select",
        title: "Тип запроса",
        description:
          "Выберите тип запроса на техническую поддержку со стороны департамента DS Russia TechSales",
        options: [
          {
            value: 1,
            label: "Технический вопрос по работе сервиса, приложения или продукта",
            description:
              "Вопросы связанные с документированной функциональностью продукта, заложенными в него бизнес-процессами, методологией работы, лицензированием и пакетированием",
            fields: secondaryFields
          },
          {
            value: 2,
            label:
              "Проблема с установкой, работой, настройкой и доработкой сервиса, приложения или продукта",
            description:
              "Вопросы связанные с багами, ошибками при установке и работе продуктов DS, а так же их настройкой и доработкой",
            fields: [].concat(_toConsumableArray(secondaryFields), [
              {
                title: "Номер Service Request (если есть)",
                type: "text"
              },
              {
                isRequired: true,
                title: "Стек установки всего окружения",
                multiline: true,
                type: "text"
              }
            ])
          },
          {
            value: 3,
            label:
              "Запрос на предоставление материалов по продуктам (Бренды), Индустриальным Решениям, Дистрибутивов и Пакетов Обновлений",
            description:
              "Мне необходимы сейловые, технические, маркетинговые материалы по продуктам и индустриальным решениям DS, а так же дистрибутивы ПО и пакеты обновлений",
            fields: [].concat(commonFields, [
              {
                isRequired: true,
                title: "Категория материалов",
                type: "select",
                options: [
                  {
                    value: "Брендовые"
                  },
                  {
                    value: "Индустриальные"
                  },
                  {
                    value: "Дистрибутивы ПО, пакеты обновлений"
                  }
                ]
              },
              {
                isRequired: true,
                title: "Тип необходимых материалов",
                type: "select",
                options: [
                  {
                    value:
                      "Материалы для продавцов (обзорные материалы, SWOT-анализ, пакетирование)"
                  },
                  {
                    value:
                      "Технические материалы по продукту (функциональная презентация, видеоролик)"
                  },
                  {
                    value: "Маркетинговые материалы (референсы, история успеха)"
                  }
                ]
              }
            ])
          },
          {
            value: 4,
            label: "Обучение и сертификация",
            description:
              "Вопросы связанные с прохождением обучения на 3DEXPERIENCE University, 3DS Companion, доступности обучающих материалов, сертификационных программ, сдачи сертификационных экзаменов",
            fields: [].concat(commonFields, [
              {
                isRequired: true,
                title: "Запрос касается",
                type: "select",
                options: [
                  {
                    value: "3DEXPERIENCE University"
                  },
                  {
                    value: "3DS Companion Learning Space"
                  },
                  {
                    value: "Сертификация и сдача экзаменов"
                  }
                ]
              }
            ])
          },
          {
            value: 5,
            label: "Другое",
            description:
              "Если ваш запрос не попадает ни в одну из перечисленных выше категорий, то вы можете обратиться за помощью в произвольной форме",
            fields: commonFields
          }
        ]
      }
    ];

    
        function widgetLoading() {
            typeof widget != "undefined" && widget 
            	? executeWidgetCode(widget) 
            	: setTimeout(widgetLoading, 50);
        }
        widgetLoading();
    </script>


</head>

<body>
</body>

</html>